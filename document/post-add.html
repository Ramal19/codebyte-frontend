<!DOCTYPE html>
<html lang="az">

<head>
    <meta charset="UTF-8">
    <title>Kurs əlavə et</title>
    <link rel="stylesheet" href="../style/post-add.css">
</head>

<body>
    <header>
        <nav class="navbar">
            <div class="logo">
                <img src="../image/codebyteLogoMa.png" alt="LOGO">
            </div>
            <ul>
                <li><a href="../index.html">Ana Səhifə</a></li>
                <li><a href="./kurs.html">Kurslar</a></li>
                <li><a href="./telimciler.html">Təlimçilər</a></li>
                <li><a href="./contact.html">Əlaqə</a></li>
            </ul>
        </nav>
    </header>

    <div id="authActions">
        <h2>Yeni Kurs Əlavə Et</h2>

        <!-- Kurs qapağı -->
        <label class="custom-file-upload">
            <input type="file" id="courseCover" accept="image/*">
            Kurs üçün ümumi qapaq şəkli seçin
        </label>
        <br>
        <img id="courseCoverPreview" style="visibility:hidden;width:250px;margin-top:10px;">

        <!-- Kurs başlığı -->
        <input type="text" id="courseTitle" placeholder="Kursun adını daxil edin">

        <!-- Kateqoriyalar -->
        <select id="categorySelect">
            <option hidden>Kateqoriya seçin</option>
            <option value="JavaScript">JavaScript</option>
            <option value="C++">C++</option>
            <option value="React JS">React JS</option>
            <option value="Python">Python</option>
            <option value="Canva">Canva</option>
            <option value="Other">Digər</option>
        </select>

        <!-- Videolar -->
        <div id="videosContainer">
            <h3>Videolar</h3>
            <div class="video-item">
                <input type="file" class="videoInput" accept="video/*">
                <input type="file" class="thumbInput" accept="image/*">
                <input type="text" class="videoTitle" placeholder="Videonun başlığı">
            </div>
        </div>

        <button id="addMoreVideo">Daha çox video əlavə et</button>
        <button id="uploadCourseBtn">Kursu paylaş</button>
    </div>

    <script>
        const API_URL = "https://codebyte-backend-ibyq.onrender.com";
        const token = localStorage.getItem("token");
        if (!token) {
            alert("Əvvəlcə login olmalısınız");
            window.location.href = "login.html";
        }

        const addMoreVideoBtn = document.getElementById("addMoreVideo");
        const videosContainer = document.getElementById("videosContainer");
        const uploadCourseBtn = document.getElementById("uploadCourseBtn");
        const courseCoverInput = document.getElementById("courseCover");
        const courseCoverPreview = document.getElementById("courseCoverPreview");

        // Əlavə video bölməsi
        addMoreVideoBtn.addEventListener("click", () => {
            const div = document.createElement("div");
            div.className = "video-item";
            div.innerHTML = `
                <input type="file" class="videoInput" accept="video/*">
                <input type="file" class="thumbInput" accept="image/*">
                <input type="text" class="videoTitle" placeholder="Videonun başlığı">
            `;
            videosContainer.appendChild(div);
        });

        // Qapaq şəkli önizləmə
        courseCoverInput.addEventListener("change", () => {
            const file = courseCoverInput.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = e => {
                courseCoverPreview.src = e.target.result;
                courseCoverPreview.style.visibility = "visible";
            };
            reader.readAsDataURL(file);
        });

        // Kurs yükləmə
        uploadCourseBtn.addEventListener("click", async () => {
            const title = document.getElementById("courseTitle").value.trim();
            const category = document.getElementById("categorySelect").value;
            const cover = courseCoverInput.files[0];

            if (!title || !category || !cover) {
                alert("Bütün məlumatları doldurun!");
                return;
            }

            const videos = [];
            document.querySelectorAll(".video-item").forEach(div => {
                const videoFile = div.querySelector(".videoInput").files[0];
                const thumbFile = div.querySelector(".thumbInput").files[0];
                const videoTitle = div.querySelector(".videoTitle").value.trim();
                if (!videoFile || !thumbFile || !videoTitle) return;
                videos.push({ videoFile, thumbFile, videoTitle });
            });

            if (videos.length === 0) {
                alert("Ən azı bir video əlavə edin!");
                return;
            }

            const formData = new FormData();
            formData.append("text", title);
            formData.append("category", category);
            formData.append("courseCover", cover);

            videos.forEach(v => {
                formData.append("videos", v.videoFile);
                formData.append("videoCovers", v.thumbFile);
            });

            // ✅ Video başlıqları JSON kimi göndərilir
            formData.append("videoTitles", JSON.stringify(videos.map(v => v.videoTitle)));

            try {
                const res = await fetch(`${API_URL}/posts`, {
                    method: "POST",
                    headers: { Authorization: "Bearer " + token },
                    body: formData
                });

                if (!res.ok) {
                    const err = await res.json().catch(() => ({ message: "Kurs yüklənmədi" }));
                    alert("Xəta: " + err.message);
                    return;
                }

                const data = await res.json();
                alert("Kurs uğurla əlavə olundu!");
                console.log("Yeni kurs:", data);
                window.location.href = "../index.html";
            } catch (error) {
                alert("Xəta baş verdi: " + error.message);
                console.error(error);
            }
        });
    </script>
</body>

</html>
