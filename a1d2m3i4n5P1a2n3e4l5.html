<!DOCTYPE html>
<html lang="az">

<head>
  <meta charset="UTF-8">
  <title>İstifadəçilər Cədvəli</title>
  <style>
    table {
      border-collapse: collapse;
      width: 80%;
      margin: 20px auto;
    }

    th,
    td {
      border: 1px solid #ddd;
      padding: 8px;
      text-align: left;
    }

    th {
      background-color: #f2f2f2;
    }

    #search, #roleFilter {
      width: 80%;
      margin: 10px auto;
      display: block;
      padding: 8px;
      font-size: 16px;
    }

    button.delete-btn {
      background-color: #f44336;
      color: white;
      border: none;
      padding: 5px 10px;
      cursor: pointer;
      border-radius: 4px;
    }

    button.delete-btn:hover {
      background-color: #d32f2f;
    }
  </style>
</head>

<body>

  <h1>Qeydiyyatdan Keçmiş İstifadəçilər</h1>

  <input type="text" id="search" placeholder="İstifadəçi adı və ya email üzrə axtar...">

  <select id="roleFilter">
    <option value="">Hamısı</option>
    <option value="user">User</option>
    <option value="teacher">Teacher</option>
  </select>

  <table id="users-table">
    <thead>
      <tr>
        <th>ID</th>
        <th>İstifadəçi Adı</th>
        <th>Email</th>
        <th>Role</th>
        <th>Əməliyyat</th>
      </tr>
    </thead>
    <tbody>
    </tbody>
  </table>

  <script>
    const API_URL = "https://codebyte-backend-ibyq.onrender.com//users";
    const tableBody = document.querySelector("#users-table tbody");
    const searchInput = document.querySelector("#search");
    const roleFilter = document.querySelector("#roleFilter");

    let allUsers = []; 

    async function fetchUsers() {
      try {
        const response = await fetch(API_URL);

        if (!response.ok) {
          throw new Error(`HTTP xətası! Status: ${response.status}`);
        }

        allUsers = await response.json();
        displayUsers(allUsers);

      } catch (error) {
        console.error("Məlumat gətirilərkən xəta:", error);
        tableBody.innerHTML = `<tr><td colspan="5" style="color:red;">Məlumatlar yüklənə bilmədi. Serveri yoxlayın.</td></tr>`;
      }
    }

    function displayUsers(users) {
      tableBody.innerHTML = "";

      users.forEach((user, index) => {
        const row = tableBody.insertRow();
        row.insertCell().textContent = index + 1; // ID
        row.insertCell().textContent = user.username;
        row.insertCell().textContent = user.email;
        row.insertCell().textContent = user.role;

        const deleteCell = row.insertCell();
        const deleteBtn = document.createElement("button");
        deleteBtn.textContent = "Sil";
        deleteBtn.classList.add("delete-btn");
        deleteBtn.addEventListener("click", () => deleteUser(user.id));
        deleteCell.appendChild(deleteBtn);
      });
    }

    async function deleteUser(id) {
      if (!confirm("Bu istifadəçini silmək istədiyinizə əminsiniz?")) return;

      try {
        const response = await fetch(`${API_URL}/${id}`, {
          method: "DELETE"
        });

        if (!response.ok) throw new Error("Silinmə xətası!");

        allUsers = allUsers.filter(user => user.id !== id);
        applyFilters();

      } catch (error) {
        alert("İstifadəçi silinə bilmədi!");
        console.error(error);
      }
    }

    function applyFilters() {
      const query = searchInput.value.toLowerCase();
      const role = roleFilter.value;

      const filteredUsers = allUsers.filter(user =>
        (user.username.toLowerCase().includes(query) || user.email.toLowerCase().includes(query)) &&
        (role === "" || user.role === role)
      );

      displayUsers(filteredUsers);
    }

    searchInput.addEventListener("input", applyFilters);
    roleFilter.addEventListener("change", applyFilters);

    fetchUsers();
  </script>
</body>

</html>
